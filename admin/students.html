<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Student | Admin | MCS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: #F6F1E8;
        }

        .title-font {
            font-family: 'Cormorant Garamond', serif;
        }

        input,
        select,
        textarea {
            width: 100%;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-family: 'Outfit', sans-serif;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.15s, box-shadow 0.15s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #0F3D3E;
            box-shadow: 0 0 0 3px rgba(15, 61, 62, 0.1);
        }

        label {
            display: block;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #6b7280;
            margin-bottom: 0.4rem;
        }

        /* Hidden PDF Template */
        #pdf-template {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 794px;
            background: white;
            font-family: 'Times New Roman', serif;
            font-size: 12px;
            color: #000;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>

<body class="min-h-screen p-6 md:p-10">

    <!-- Auth check -->
    <script>
        if (sessionStorage.getItem('isAdmin') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>

    <!-- Toast -->
    <div id="toast" class="fixed top-5 right-5 z-50 hidden">
        <div id="toast-inner"
            class="flex items-center gap-3 px-5 py-4 rounded-xl shadow-2xl text-sm font-semibold text-white min-w-[280px]">
            <span id="toast-icon"></span>
            <span id="toast-msg"></span>
        </div>
    </div>

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="flex items-center justify-between mb-8">
            <div>
                <h1 class="title-font text-4xl font-bold text-[#0F3D3E]">Add Student</h1>
                <p class="text-gray-500 text-sm mt-1">Register a new student record with photo and generate their
                    admission certificate.</p>
            </div>
            <div class="flex gap-3">
                <a href="/admin"
                    class="px-5 py-2 text-sm font-semibold text-[#0F3D3E] border border-[#0F3D3E]/30 rounded-lg hover:bg-[#0F3D3E]/5 transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                        </path>
                    </svg>
                    Image Add
                </a>
                <button onclick="logout()"
                    class="px-4 py-2 text-sm font-semibold text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition-colors">Sign
                    Out</button>
            </div>
        </header>

        <form id="student-form" onsubmit="submitForm(event)">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- LEFT: Photo + Status -->
                <div class="space-y-5">
                    <!-- Photo Upload -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-white/60">
                        <h2 class="font-bold text-[#0F3D3E] mb-4 flex items-center gap-2">
                            <span
                                class="w-6 h-6 rounded-full bg-[#C6A75E]/20 text-[#C6A75E] flex items-center justify-center text-xs font-bold">1</span>
                            Student Photo
                        </h2>
                        <div class="relative group/photo cursor-pointer"
                            onclick="document.getElementById('photo-file').click()">
                            <input type="file" id="photo-file" accept="image/*" class="hidden"
                                onchange="previewPhoto(this)">
                            <div id="photo-preview-wrap"
                                class="w-full aspect-[3/4] max-w-[180px] mx-auto rounded-xl overflow-hidden border-2 border-dashed border-gray-300 group-hover/photo:border-[#C6A75E] bg-gray-50 flex items-center justify-center transition-all">
                                <img id="photo-preview" src="" class="hidden w-full h-full object-cover">
                                <div id="photo-placeholder" class="text-center text-gray-400 p-4">
                                    <svg class="w-10 h-10 mx-auto mb-2" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                    <p class="text-xs font-medium">Click to upload</p>
                                    <p class="text-[10px] mt-0.5">JPG, PNG ¬∑ Passport size</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status & Fees -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-white/60 space-y-4">
                        <h2 class="font-bold text-[#0F3D3E] mb-2 flex items-center gap-2">
                            <span
                                class="w-6 h-6 rounded-full bg-[#C6A75E]/20 text-[#C6A75E] flex items-center justify-center text-xs font-bold">2</span>
                            Status
                        </h2>
                        <div>
                            <label>Admission Status</label>
                            <select id="status" name="status" required>
                                <option value="Active">Active</option>
                                <option value="Deactive">Deactive</option>
                            </select>
                        </div>
                        <div>
                            <label>Fees Status</label>
                            <select id="fees" name="fees" required>
                                <option value="No Dues">No Dues</option>
                                <option value="Dues">Dues</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: All Fields -->
                <div class="lg:col-span-2 space-y-5">

                    <!-- Basic Info -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-white/60">
                        <h2 class="font-bold text-[#0F3D3E] mb-4 flex items-center gap-2">
                            <span
                                class="w-6 h-6 rounded-full bg-[#C6A75E]/20 text-[#C6A75E] flex items-center justify-center text-xs font-bold">3</span>
                            Basic Information
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label>Student Full Name *</label>
                                <input type="text" id="studentName" name="studentName"
                                    placeholder="e.g. Mohammed Abdullah" required>
                            </div>
                            <div>
                                <label>Admission Number *</label>
                                <input type="text" id="admissionNo" name="admissionNo" placeholder="e.g. MCS-2024-001"
                                    required style="text-transform:uppercase">
                            </div>
                            <div>
                                <label>Admission Date *</label>
                                <input type="date" id="admissionDate" name="admissionDate" required>
                            </div>
                            <div>
                                <label>Gender *</label>
                                <select id="gender" name="gender" required>
                                    <option value="">Select gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                            <div>
                                <label>Date of Birth *</label>
                                <input type="date" id="dob" name="dob" required>
                            </div>
                            <div>
                                <label>Aadhar Number</label>
                                <input type="text" id="aadharNo" name="aadharNo" placeholder="XXXX XXXX XXXX"
                                    maxlength="14">
                            </div>
                            <div>
                                <label>T.C. Number</label>
                                <input type="text" id="tcNo" name="tcNo" placeholder="Transfer Certificate No.">
                            </div>
                        </div>
                    </div>

                    <!-- Family Info -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-white/60">
                        <h2 class="font-bold text-[#0F3D3E] mb-4 flex items-center gap-2">
                            <span
                                class="w-6 h-6 rounded-full bg-[#C6A75E]/20 text-[#C6A75E] flex items-center justify-center text-xs font-bold">4</span>
                            Family Details
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label>Father's Name *</label>
                                <input type="text" id="fatherName" name="fatherName" placeholder="Father's full name"
                                    required>
                            </div>
                            <div>
                                <label>Mother's Name</label>
                                <input type="text" id="motherName" name="motherName" placeholder="Mother's full name">
                            </div>
                            <div>
                                <label>Guardian's Name</label>
                                <input type="text" id="guardianName" name="guardianName"
                                    placeholder="Guardian's full name (if applicable)">
                            </div>
                            <div class="md:col-span-1">
                                <label>Address</label>
                                <textarea id="address" name="address" rows="2"
                                    placeholder="Full residential address"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Submit -->
                    <button type="submit" id="submit-btn"
                        class="w-full py-4 bg-gradient-to-r from-[#0F3D3E] to-[#1a5f61] text-white font-bold text-sm uppercase tracking-widest rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <span id="submit-label">Save Student & Generate Certificate</span>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         ALL STUDENTS SECTION
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="max-w-5xl mx-auto mt-16 pb-20">

        <!-- Section Header -->
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-[#0F3D3E] flex items-center justify-center">
                    <svg class="w-5 h-5 text-[#C6A75E]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
                <div>
                    <h2 class="title-font text-2xl font-bold text-[#0F3D3E]">All Students</h2>
                    <p class="text-gray-400 text-xs">
                        <span id="student-count" class="font-bold text-[#0F3D3E]">‚Äî</span> registered records
                    </p>
                </div>
            </div>
            <!-- Search Bar -->
            <div class="relative w-full sm:w-72">
                <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"
                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input id="student-search" type="text" placeholder="Search by name or admission no..."
                    class="w-full pl-9 pr-4 py-2.5 text-sm bg-white border border-gray-200 rounded-xl outline-none focus:border-[#0F3D3E] focus:ring-2 focus:ring-[#0F3D3E]/10 transition-all"
                    oninput="filterStudents(this.value)">
            </div>
        </div>

        <!-- Student List -->
        <div id="student-list" class="space-y-3">
            <!-- Skeletons while loading -->
            <div id="student-skeletons" class="space-y-3">
                <div class="animate-pulse bg-white rounded-2xl h-20 border border-gray-100"></div>
                <div class="animate-pulse bg-white rounded-2xl h-20 border border-gray-100"></div>
                <div class="animate-pulse bg-white rounded-2xl h-20 border border-gray-100"></div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="student-empty" class="hidden text-center py-20">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-9 h-9 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </div>
            <h3 class="title-font text-2xl text-[#0F3D3E] font-bold mb-2">No Students Yet</h3>
            <p class="text-gray-400 text-sm">Add your first student using the form above.</p>
        </div>

        <!-- No Search Results -->
        <div id="student-no-results" class="hidden text-center py-12">
            <p class="text-gray-400 text-sm">No students match your search.</p>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Delete Confirmation Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="delete-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4"
        style="background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);">
        <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-8 text-center"
            style="animation:slideUpModal 0.3s cubic-bezier(0.34,1.56,0.64,1) forwards;">
            <style>
                @keyframes slideUpModal {
                    from {
                        opacity: 0;
                        transform: translateY(20px)
                    }

                    to {
                        opacity: 1;
                        transform: translateY(0)
                    }
                }
            </style>
            <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-5">
                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </div>
            <h3 class="title-font text-2xl font-bold text-[#0F3D3E] mb-2">Delete Student?</h3>
            <p class="text-gray-500 text-sm mb-1">You're about to permanently delete:</p>
            <p id="delete-modal-name" class="font-bold text-[#0F3D3E] text-base mb-6"></p>
            <p class="text-red-500 text-xs mb-6 bg-red-50 rounded-xl px-4 py-2">This action cannot be undone. The
                student record will be permanently removed.</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()"
                    class="flex-1 py-3 rounded-xl border border-gray-200 text-gray-600 font-semibold text-sm hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button id="confirm-delete-btn" onclick="confirmDelete()"
                    class="flex-1 py-3 rounded-xl bg-red-500 hover:bg-red-600 text-white font-bold text-sm transition-colors">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden PDF Template (rendered in browser, captured by html2canvas) -->
    <div id="pdf-template" aria-hidden="true">
        <div style="padding:40px; font-family:'Times New Roman',serif; color:#000; border: 2px solid #000;">

            <!-- School Header -->
            <div
                style="text-align:center; border-bottom:2px solid #000; padding-bottom:16px; margin-bottom:16px; position:relative;">
                <div id="pdf-photo-box"
                    style="position:absolute;right:0;top:0;width:90px;height:110px;border:1px solid #000;overflow:hidden;background:#f0f0f0;display:flex;align-items:center;justify-content:center;">
                    <img id="pdf-photo" src="" style="width:100%;height:100%;object-fit:cover;">
                </div>
                <h1
                    style="font-size:22px;font-weight:900;letter-spacing:1px;text-transform:uppercase;margin:0 100px 4px 0;">
                    MODERN CALCUTTA SCHOOL</h1>
                <p style="font-size:11px;color:#333;margin:0 100px 2px 0;">Foundation of Ilm-o-Adab</p>
                <p style="font-size:10px;color:#333;margin:0 100px 0 0;">Millat Colony, Phulwarisharif, Patna ‚Äì 801505,
                    Bihar</p>
                <p style="font-size:10px;color:#333;margin:4px 100px 0 0;">üìû +91 87098 61044 &nbsp;|&nbsp;
                    mcs.patna2019@gmail.com</p>
            </div>

            <!-- Title -->
            <h2
                style="text-align:center;font-size:15px;font-weight:700;letter-spacing:2px;text-transform:uppercase;text-decoration:underline;margin-bottom:20px;">
                ADMISSION CERTIFICATE
            </h2>

            <!-- Details Table -->
            <table style="width:100%;border-collapse:collapse;font-size:11px;margin-bottom:20px;">
                <tbody id="pdf-table-body">
                    <!-- Rows injected by JS -->
                </tbody>
            </table>

            <!-- Declaration -->
            <div style="border:1px solid #000;padding:12px;font-size:10px;line-height:1.7;margin-bottom:24px;">
                <strong>Declaration:</strong> This is to certify that the above-named student has been duly admitted to
                Modern Calcutta School, Phulwarisharif, Patna. The information recorded above is correct to the best of
                our knowledge.
            </div>

            <!-- Signatures -->
            <div style="display:flex;justify-content:space-between;margin-top:40px;font-size:10px;">
                <div style="text-align:center;">
                    <div style="border-top:1px solid #000;width:160px;padding-top:6px;">Parent / Guardian</div>
                </div>
                <div style="text-align:center;">
                    <div style="border-top:1px solid #000;width:160px;padding-top:6px;">Class Teacher</div>
                </div>
                <div style="text-align:center;">
                    <div style="border-top:1px solid #000;width:160px;padding-top:6px;">Principal / Director</div>
                </div>
            </div>

            <p
                style="font-size:9px;color:#666;text-align:center;margin-top:20px;border-top:1px solid #ddd;padding-top:10px;">
                Generated on <span id="pdf-date"></span> ¬∑ Modern Calcutta School Official Document
            </p>
        </div>
    </div>

    <script>
        // Auth
        window.logout = () => { sessionStorage.removeItem('isAdmin'); window.location.href = 'login.html'; };

        // Photo preview
        function previewPhoto(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('photo-preview').src = e.target.result;
                document.getElementById('photo-preview').classList.remove('hidden');
                document.getElementById('photo-placeholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        // Toast
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            const inner = document.getElementById('toast-inner');
            const msgEl = document.getElementById('toast-msg');
            const iconEl = document.getElementById('toast-icon');
            msgEl.textContent = msg;
            inner.className = `flex items-center gap-3 px-5 py-4 rounded-xl shadow-2xl text-sm font-semibold text-white min-w-[280px] ${type === 'success' ? 'bg-[#0F3D3E]' : 'bg-red-500'}`;
            iconEl.textContent = type === 'success' ? '‚úÖ' : '‚ùå';
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 4000);
        }

        function setSubmitting(yes) {
            const btn = document.getElementById('submit-btn');
            const label = document.getElementById('submit-label');
            btn.disabled = yes;
            if (yes) {
                label.innerHTML = `<svg class="spinner w-5 h-5 inline-block mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>Saving...`;
            } else {
                label.textContent = 'Save Student & Generate Certificate';
            }
        }

        async function submitForm(e) {
            e.preventDefault();
            setSubmitting(true);

            try {
                // Build FormData
                const form = document.getElementById('student-form');
                const fd = new FormData();
                const photoFile = document.getElementById('photo-file').files[0];
                if (photoFile) fd.append('photo', photoFile, photoFile.name);

                const fields = ['studentName', 'admissionNo', 'admissionDate', 'gender', 'dob', 'aadharNo',
                    'fatherName', 'motherName', 'guardianName', 'address', 'status', 'fees', 'tcNo'];
                fields.forEach(id => {
                    const el = document.getElementById(id);
                    fd.append(id, el.value || '');
                });

                // ‚îÄ‚îÄ Step 1: Save student record ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                setLabel('üíæ Saving student record...');
                const saveRes = await fetch('/api/add-student', { method: 'POST', body: fd });
                const saveData = await saveRes.json();

                if (!saveRes.ok) {
                    showToast(saveData.error || 'Failed to save student', 'error');
                    return;
                }

                const student = saveData.student;
                const admissionNo = student.admissionNo;
                const studentId = student.id;

                // ‚îÄ‚îÄ Step 2: Generate PDF (silently, no download) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                setLabel('üìÑ Generating certificate...');
                populatePdfTemplate(student);
                await new Promise(r => setTimeout(r, 200)); // let DOM paint

                const canvas = await html2canvas(document.getElementById('pdf-template'), {
                    scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff'
                });

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/jpeg', 0.85);
                const imgProps = pdf.getImageProperties(imgData);
                const pdfW = pdf.internal.pageSize.getWidth();
                const pdfH = (imgProps.height * pdfW) / imgProps.width;
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfW, pdfH);
                const pdfBlob = pdf.output('blob');

                // ‚îÄ‚îÄ Step 3: Upload PDF to Vercel Blob ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                setLabel('‚òÅÔ∏è Uploading certificate...');
                const pdfRes = await fetch('/api/upload-pdf', {
                    method: 'POST',
                    headers: { 'x-admission-no': admissionNo, 'Content-Type': 'application/pdf' },
                    body: pdfBlob
                });
                const pdfData = await pdfRes.json();

                // ‚îÄ‚îÄ Step 4: Save pdfUrl back to Firestore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                if (pdfRes.ok && pdfData.url) {
                    setLabel('üîó Saving certificate link...');
                    await fetch('/api/update-student', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ studentId, pdfUrl: pdfData.url })
                    });
                }

                // ‚îÄ‚îÄ Step 5: Show success ‚Äî NO auto-download ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                showSuccessBanner(student.studentName, admissionNo);

                // Reset form
                form.reset();
                document.getElementById('photo-preview').classList.add('hidden');
                document.getElementById('photo-placeholder').classList.remove('hidden');

            } catch (err) {
                console.error(err);
                showToast('Something went wrong: ' + err.message, 'error');
            } finally {
                setSubmitting(false);
            }
        }

        function setLabel(text) {
            document.getElementById('submit-label').innerHTML = `
                <svg class="spinner w-5 h-5 inline-block mr-2" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                </svg>${text}`;
        }

        function showSuccessBanner(name, admissionNo) {
            // Remove any existing banner
            document.getElementById('success-banner')?.remove();

            const banner = document.createElement('div');
            banner.id = 'success-banner';
            banner.style.cssText = `
                position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
                z-index:9999;min-width:340px;max-width:480px;
                background:linear-gradient(135deg,#0F3D3E,#1a5f61);
                color:white;border-radius:20px;padding:20px 24px;
                box-shadow:0 20px 60px rgba(15,61,62,0.4);
                animation:slideUpBanner 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards;
            `;
            banner.innerHTML = `
                <style>@keyframes slideUpBanner{from{opacity:0;transform:translateX(-50%) translateY(30px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}</style>
                <div style="display:flex;align-items:flex-start;gap:14px;">
                    <div style="width:44px;height:44px;background:rgba(198,167,94,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:22px;">‚úÖ</div>
                    <div style="flex:1;">
                        <p style="font-weight:700;font-size:15px;margin:0 0 4px;">${name} registered!</p>
                        <p style="font-size:12px;opacity:0.75;margin:0 0 14px;">Certificate uploaded. Student can now download it from the portal.</p>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;">
                            <a href="/student-portal.html" target="_blank"
                               style="flex:1;text-align:center;background:#C6A75E;color:#fff;font-size:11px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;padding:8px 16px;border-radius:10px;text-decoration:none;">
                                üîó View in Student Portal
                            </a>
                            <button onclick="document.getElementById('success-banner').remove()"
                                style="padding:8px 14px;background:rgba(255,255,255,0.1);border:none;color:white;border-radius:10px;font-size:11px;cursor:pointer;font-weight:600;">
                                Dismiss
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(banner);

            // Auto-dismiss after 15 seconds
            setTimeout(() => banner?.remove(), 15000);

            // Refresh student list to show newly added student
            loadStudents();
        }

        function populatePdfTemplate(s) {
            // Photo
            const photoImg = document.getElementById('pdf-photo');
            if (s.photoUrl) { photoImg.src = s.photoUrl; }
            else { document.getElementById('pdf-photo-box').style.display = 'none'; }

            // Date
            document.getElementById('pdf-date').textContent = new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'long', year: 'numeric' });

            // Table rows
            const rows = [
                ['Student Name', s.studentName],
                ['Admission Number', s.admissionNo],
                ['Admission Date', s.admissionDate],
                ['Gender', s.gender],
                ['Date of Birth', s.dob],
                ["Father's Name", s.fatherName],
                ["Mother's Name", s.motherName],
                ["Guardian's Name", s.guardianName],
                ['Aadhar Number', s.aadharNo],
                ['Address', s.address],
                ['T.C. Number', s.tcNo],
                ['Admission Status', s.status],
                ['Fees Status', s.fees],
            ];

            const tbody = document.getElementById('pdf-table-body');
            tbody.innerHTML = rows
                .filter(([, v]) => v)
                .map(([label, val], i) => `
                    <tr style="background:${i % 2 === 0 ? '#f9f9f9' : '#fff'}">
                        <td style="border:1px solid #000;padding:6px 10px;font-weight:700;width:35%;background:#f0f0f0;">${label}</td>
                        <td style="border:1px solid #000;padding:6px 10px;">${val}</td>
                    </tr>
                `).join('');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STUDENT LIST LOGIC
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let allStudents = [];   // cached full list for filtering
        let pendingDeleteId = null;

        async function loadStudents() {
            try {
                const res = await fetch('/api/students-list');
                const data = await res.json();

                // Hide skeletons
                document.getElementById('student-skeletons').remove();

                if (!res.ok || !data.students) throw new Error(data.error || 'Failed');

                allStudents = data.students;
                document.getElementById('student-count').textContent = allStudents.length;
                renderStudentList(allStudents);
            } catch (err) {
                console.error('[loadStudents]', err);
                document.getElementById('student-skeletons').innerHTML =
                    `<p class="text-center text-red-400 text-sm py-8">Could not load students: ${err.message}</p>`;
            }
        }

        function renderStudentList(students) {
            const list = document.getElementById('student-list');
            const empty = document.getElementById('student-empty');
            const noResults = document.getElementById('student-no-results');

            // Clear rendered cards (keep skeletons container if exists)
            list.querySelectorAll('.student-card').forEach(c => c.remove());
            empty.classList.add('hidden');
            noResults.classList.add('hidden');

            if (students.length === 0 && allStudents.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            if (students.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }

            students.forEach((s, idx) => {
                const card = document.createElement('div');
                card.className = 'student-card bg-white rounded-2xl border border-gray-100 shadow-sm hover:shadow-md hover:border-[#C6A75E]/30 transition-all duration-200 overflow-hidden';
                card.style.animation = `fadeInCard 0.3s ease ${idx * 0.04}s both`;

                const isActive = s.status === 'Active';
                const noDues = s.fees === 'No Dues';
                const photoSrc = s.photoUrl ||
                    `https://ui-avatars.com/api/?name=${encodeURIComponent(s.studentName)}&background=0F3D3E&color=C6A75E&size=80&bold=true`;
                const admDate = s.admissionDate || '‚Äî';
                const createdAt = s.createdAt ? new Date(s.createdAt).toLocaleDateString('en-IN') : '‚Äî';

                card.innerHTML = `
                    <div class="flex items-center gap-4 p-4">
                        <!-- Photo -->
                        <div class="w-14 h-14 rounded-xl overflow-hidden flex-shrink-0 border border-gray-100 bg-gray-50">
                            <img src="${photoSrc}" alt="${s.studentName}" class="w-full h-full object-cover"
                                onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(s.studentName)}&background=0F3D3E&color=C6A75E&size=80'">
                        </div>

                        <!-- Main Info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <h3 class="font-bold text-[#0F3D3E] text-sm truncate">${s.studentName}</h3>
                                <span class="px-2 py-0.5 rounded-full text-[9px] font-bold uppercase tracking-wider ${isActive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600'}">${s.status}</span>
                                <span class="px-2 py-0.5 rounded-full text-[9px] font-bold uppercase tracking-wider ${noDues ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}">${s.fees}</span>
                            </div>
                            <p class="text-gray-400 text-xs mt-0.5 font-mono">${s.admissionNo}</p>
                            <div class="flex gap-4 mt-1">
                                <span class="text-gray-400 text-[10px]">üë§ ${s.fatherName || '‚Äî'}</span>
                                <span class="text-gray-400 text-[10px]">üìÖ ${admDate}</span>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <!-- Portal Link -->
                            <a href="/student-portal.html" target="_blank"
                                title="View in Student Portal"
                                class="w-9 h-9 rounded-xl bg-[#0F3D3E]/5 hover:bg-[#0F3D3E]/10 flex items-center justify-center transition-colors group">
                                <svg class="w-4 h-4 text-[#0F3D3E] group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                </svg>
                            </a>
                            <!-- Delete -->
                            <button onclick="openDeleteModal('${s.id}', '${s.studentName.replace(/'/g, "\\'")}')"
                                title="Delete student"
                                class="w-9 h-9 rounded-xl bg-red-50 hover:bg-red-500 flex items-center justify-center transition-all group">
                                <svg class="w-4 h-4 text-red-400 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function filterStudents(q) {
            const query = q.toLowerCase().trim();
            if (!query) {
                document.getElementById('student-count').textContent = allStudents.length;
                renderStudentList(allStudents);
                return;
            }
            const filtered = allStudents.filter(s =>
                s.studentName?.toLowerCase().includes(query) ||
                s.admissionNo?.toLowerCase().includes(query) ||
                s.fatherName?.toLowerCase().includes(query)
            );
            document.getElementById('student-count').textContent = filtered.length;
            renderStudentList(filtered);
        }

        // ‚îÄ‚îÄ Delete Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openDeleteModal(id, name) {
            pendingDeleteId = id;
            document.getElementById('delete-modal-name').textContent = name;
            const modal = document.getElementById('delete-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeDeleteModal() {
            pendingDeleteId = null;
            const modal = document.getElementById('delete-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function confirmDelete() {
            if (!pendingDeleteId) return;
            const btn = document.getElementById('confirm-delete-btn');
            btn.disabled = true;
            btn.textContent = 'Deleting...';

            try {
                const res = await fetch('/api/delete-student', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ studentId: pendingDeleteId })
                });
                const data = await res.json();

                if (!res.ok) throw new Error(data.error || 'Delete failed');

                showToast('Student deleted successfully.', 'success');
                closeDeleteModal();
                // Remove from cache and re-render
                allStudents = allStudents.filter(s => s.id !== pendingDeleteId);
                document.getElementById('student-count').textContent = allStudents.length;
                document.getElementById('student-search').value = '';
                renderStudentList(allStudents);
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Delete';
            }
        }

        // Close modal on backdrop click
        document.getElementById('delete-modal').addEventListener('click', function (e) {
            if (e.target === this) closeDeleteModal();
        });

        // CSS for card entrance animation
        const style = document.createElement('style');
        style.textContent = `@keyframes fadeInCard{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}`;
        document.head.appendChild(style);

        // Load on page ready
        loadStudents();

    </script>
</body>

</html>